<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker v7 Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-pink: #fff0f5;
            --grid-line: #e6c8ca;
            --card-bg: #FFF9F5;
            --text-color: #5D4037;
            --primary-pink: #FFDEE9;
            --status-green: #B5EAD7;
            --status-purple: #E0BBE4;
            --status-empty: #eaeaea;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Patrick Hand', cursive; color: var(--text-color);
            background-color: var(--bg-pink);
            background-image:
              linear-gradient(var(--grid-line) 1px, transparent 1px),
              linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex; justify-content: center; min-height: 100vh;
        }

        .app-container {
            width: 100%; min-width: 250px;
            background: var(--card-bg); margin: 10px; border-radius: 20px; padding: 15px;
            box-shadow: 8px 8px 0px rgba(93, 64, 55, 0.05); border: 3px solid #fff;
            display: flex; flex-direction: column; gap: 15px; position: relative; height: fit-content;
        }

        h2 { margin: 0; text-align: center; font-family: 'Gaegu', cursive; font-size: 1.6rem; letter-spacing: 1px; }
        .status-bar { text-align: center; font-size: 0.75rem; color: #bbb; height: 1rem; margin-top: -5px; }

        .mood-section { display: flex; justify-content: space-around; padding-bottom: 12px; border-bottom: 2px dashed var(--primary-pink); }
        .mood-btn { font-size: 24px; cursor: pointer; background: none; border: none; opacity: 0.4; filter: grayscale(0.6); transition: all 0.2s; }
        .mood-btn.active { opacity: 1; filter: grayscale(0); transform: scale(1.3); }

        .habit-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .habit-item {
            display: flex; align-items: center; justify-content: space-between;
            background: white; padding: 0.8rem 1rem; border-radius: 12px;
            box-shadow: 2px 3px 6px rgba(0,0,0,0.03); cursor: pointer; transition: all 0.1s; border: 2px solid transparent; overflow: hidden;
        }
        .habit-item:active { transform: scale(0.98); }
        .habit-item:hover { border-color: var(--primary-pink); transform: translateY(-1px); }
        .habit-text { font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 8px; }
        .custom-checkbox { width: 22px; height: 22px; border: 2px solid var(--primary-pink); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.2s; }
        .habit-item.checked .custom-checkbox { background: var(--status-green); border-color: var(--status-green); }
        .habit-item.checked .habit-text { text-decoration: line-through; opacity: 0.5; }
        .check-icon { color: white; font-size: 14px; display: none; }
        .habit-item.checked .check-icon { display: block; }

        .card-panel { background: rgba(255, 255, 255, 0.6); padding: 10px; border-radius: 12px; border: 1px solid white; }
        h3 { font-size: 0.9rem; opacity: 0.8; margin: 0 0 8px 0; text-align: center; }

        .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(6px, 1fr)); gap: 2px; margin-top: 5px; justify-content: center; }
        .heat-cell { aspect-ratio: 1/1; border-radius: 1px; background-color: var(--status-empty); }

        .weekly-stripe { display: flex; justify-content: space-between; padding: 0 5px; }
        .day-column { display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .day-label { font-size: 0.7rem; color: #aaa; }
        .day-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--status-empty); }

        .fab-edit {
            position: absolute; top: 15px; right: 15px; width: 32px; height: 32px; background: white;
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 1rem; border: 1px solid #eee; z-index: 10;
        }
        .fab-edit:hover { background-color: var(--primary-pink); color: white; border-color: var(--primary-pink); }

        /* --- ÁÆ°ÁêÜÈù¢Êùø (UIÂ¢ûÂº∫) --- */
        .modal-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.98); z-index: 100; border-radius: 20px; 
            display: none; flex-direction: column; padding: 20px; 
        }
        
        .manager-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* ÂàóË°®Âå∫ÂüüÊ†∑Âºè */
        .manager-list { 
            flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; 
            padding-right: 5px; /* ÁïôÁªôÊªöÂä®Êù° */
        }
        
        .manager-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; background: var(--bg-pink); border-radius: 10px; font-size: 1rem; 
        }

        .habit-name-span {
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 15px; flex-grow: 1;
        }
        
        /* Âà†Èô§ÊåâÈíÆÊ†∑Âºè */
        .btn-delete-item { 
            background: #ffebee; color: #d32f2f; 
            border: 1px solid #ffcdd2; border-radius: 6px;
            padding: 6px 14px; cursor: pointer; font-size: 0.8rem; font-weight: bold;
            flex-shrink: 0; /* Èò≤Ê≠¢Ë¢´Êå§Âéã */
            transition: all 0.2s;
        }
        .btn-delete-item:active { transform: scale(0.95); }
        .btn-delete-item.confirm-state { background: #d32f2f; color: white; border-color: #b71c1c; }

        .add-area { margin-top: auto; padding-top: 15px; border-top: 2px dashed #eee; }
        .add-row { display: flex; gap: 10px; margin-bottom: 10px; }
        #new-habit-input { flex-grow: 1; padding: 10px; border: 2px solid var(--grid-line); border-radius: 8px; font-family: inherit; font-size: 1rem; }
        .btn-confirm { background: var(--status-green); border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #444; }
        .btn-close-modal { width: 100%; padding: 10px; background: #eee; border:none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666;}

        .loading-mask { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 50; border-radius: 20px; display: flex; justify-content: center; align-items: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="fab-edit" onclick="openManager()" title="Edit Habits">‚úèÔ∏è</div>

    <div>
        <h2 id="current-date">Today</h2>
        <div class="status-bar" id="sync-status">Ready</div>
        <div class="mood-section" id="mood-container"></div>
    </div>

    <div class="habit-list" id="habit-list"></div>

    <div class="card-panel">
        <h3>Weekly Trace</h3>
        <div class="weekly-stripe" id="weekly-stripe"></div>
    </div>

    <div class="card-panel">
        <h3>180 Days Log</h3>
        <div class="heatmap-grid" id="heatmap-grid"></div>
    </div>

    <div class="loading-mask" id="loading-mask">Syncing... ‚òÅÔ∏è</div>

    <!-- ÁÆ°ÁêÜÈù¢Êùø -->
    <div class="modal-overlay" id="manager-modal">
        <div class="manager-header">
            <h3 style="margin:0; font-size:1.4rem;">Manage Habits</h3>
        </div>
        
        <div class="manager-list" id="manager-list">
            <!-- JS Âä®ÊÄÅÁîüÊàêÔºå‰∏ç‰ΩøÁî® innerHTML ÊãºÊé• -->
        </div>

        <div class="add-area">
            <div class="add-row">
                <input type="text" id="new-habit-input" placeholder="Name...">
                <button class="btn-confirm" onclick="addNewHabit()">Add</button>
            </div>
            <button class="btn-close-modal" onclick="closeManager()">Close</button>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        BIN_ID: "694dff0f43b1c97be9057b5d",
        API_KEY: "$2a$10$ZCtav3eUvsq6lxm97e.e8.9JHlS0p/6Qh4ELXFdlECtgFY/1L1mz6"
    };

    const TARGET_HABITS = ['üõñ ‰ª£Á†Å', 'üé® ÁîªÁîª', 'üßò Áëú‰ºΩ', 'üôá‚Äç‚ôÄÔ∏è Êó•ËØ≠', 'ü§Ω ÈòªÂäõËÆ≠ÁªÉ', 'üíñ ËÆ∞ÂΩïÁîüÊ¥ª', 'üéÄ Ë∫´‰Ωì‰øùÂÖª', 'üåï ÂÜ•ÊÉ≥'];
    const MOODS = ['ü§©', 'üòä', 'üòê', 'üò´', 'üò°'];
    
    let appData = {
        habits: [...TARGET_HABITS], 
        records: {}
    };

    const getTodayStr = () => {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    };
    const todayStr = getTodayStr();

    // --- ‰∫ëÁ´ØÂêåÊ≠• ---
    const updateStatus = (msg) => document.getElementById('sync-status').innerText = msg;
    const showLoading = (show) => document.getElementById('loading-mask').style.display = show ? 'flex' : 'none';

    async function fetchCloudData() {
        showLoading(true);
        updateStatus("Syncing...");
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                headers: { 'X-Master-Key': CONFIG.API_KEY }
            });
            if(!res.ok) throw new Error("Net Error");
            const json = await res.json();
            
            if(json.record && json.record.habits && json.record.habits.length > 0) {
                appData.habits = json.record.habits;
                appData.records = json.record.records || {};
            } else {
                appData.habits = [...TARGET_HABITS];
                saveToCloud();
            }

            initTodayRecord();
            renderAll();
            updateStatus("Synced ‚úì");
        } catch (e) {
            console.error(e);
            updateStatus("Offline Mode");
            const local = localStorage.getItem('habit_180_backup');
            if(local) { appData = JSON.parse(local); } else { appData.habits = [...TARGET_HABITS]; }
            initTodayRecord();
            renderAll();
        } finally {
            showLoading(false);
        }
    }

    async function saveToCloud() {
        updateStatus("Saving...");
        localStorage.setItem('habit_180_backup', JSON.stringify(appData));
        try {
            await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': CONFIG.API_KEY },
                body: JSON.stringify(appData)
            });
            updateStatus("Saved ‚úì");
        } catch (e) { updateStatus("Save Failed"); }
    }

    function initTodayRecord() {
        if (!appData.records[todayStr]) appData.records[todayStr] = { mood: null, checks: [] };
        const currentLen = appData.habits.length;
        const recordCheck = appData.records[todayStr].checks || [];
        if (recordCheck.length < currentLen) {
            for(let i = recordCheck.length; i < currentLen; i++) recordCheck.push(false);
        } else if (recordCheck.length > currentLen) {
            recordCheck.length = currentLen;
        }
        appData.records[todayStr].checks = recordCheck;
    }

    // --- ‰∏öÂä° ---
    function toggleCheck(index) {
        appData.records[todayStr].checks[index] = !appData.records[todayStr].checks[index];
        renderHabitList(); renderVisuals(); saveToCloud();
    }
    function setMood(idx) { appData.records[todayStr].mood = idx; renderMood(); saveToCloud(); }
    
    function addNewHabit() {
        const val = document.getElementById('new-habit-input').value.trim();
        if(val) {
            appData.habits.push(val);
            initTodayRecord();
            document.getElementById('new-habit-input').value = '';
            // Âà∑Êñ∞ÂΩìÂâçÁöÑÁÆ°ÁêÜÂàóË°®Âíå‰∏ªÂàóË°®
            refreshManagerListDOM(); 
            renderHabitList(); renderVisuals(); saveToCloud();
        }
    }
    
    function deleteHabit(idx) {
        // Áõ¥Êé•Âà†Èô§ÈÄªËæë
        appData.habits.splice(idx, 1);
        if(appData.records[todayStr]) appData.records[todayStr].checks.splice(idx, 1);
        refreshManagerListDOM(); 
        renderHabitList(); renderVisuals(); saveToCloud();
    }
    
    function getDayStatus(dateStr) {
        const rec = appData.records[dateStr];
        if (!rec || !rec.checks || rec.checks.length===0) return 0;
        const checked = rec.checks.filter(Boolean).length;
        if(checked === 0) return 0;
        return (checked === rec.checks.length) ? 2 : 1;
    }

    // --- Ê∏≤Êüì ---
    function renderAll() {
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'});
        renderMood(); renderHabitList(); renderVisuals();
    }

    function renderMood() {
        const c = document.getElementById('mood-container'); c.innerHTML = '';
        const m = appData.records[todayStr].mood;
        MOODS.forEach((icon, i) => {
            const b = document.createElement('button');
            b.className = `mood-btn ${m===i?'active':''}`; b.innerText = icon;
            b.onclick = () => setMood(i); c.appendChild(b);
        });
    }

    function renderHabitList() {
        const c = document.getElementById('habit-list'); c.innerHTML = '';
        const checks = appData.records[todayStr].checks;
        
        if(appData.habits.length === 0) {
            c.innerHTML = '<div style="grid-column:span 2; text-align:center; color:#999; padding:20px;">No habits yet. Click ‚úèÔ∏è to add!</div>';
            return;
        }

        appData.habits.forEach((h, i) => {
            const d = document.createElement('div');
            d.className = `habit-item ${checks[i]?'checked':''}`;
            d.onclick = () => toggleCheck(i);
            d.innerHTML = `<span class="habit-text">${h}</span><div class="custom-checkbox"><span class="check-icon">‚úî</span></div>`;
            c.appendChild(d);
        });
    }

    function renderVisuals() {
        const wb = document.getElementById('weekly-stripe'); wb.innerHTML = '';
        const days = ['S','M','T','W','T','F','S'];
        for(let i=6; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate()-i);
            const ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            const st = getDayStatus(ds);
            let col = '#eaeaea'; if(st===2) col='#B5EAD7'; if(st===1) col='#E0BBE4';
            const el = document.createElement('div'); el.className='day-column';
            el.innerHTML = `<div class="day-dot" style="background:${col}"></div><span class="day-label">${days[d.getDay()]}</span>`;
            wb.appendChild(el);
        }

        const hb = document.getElementById('heatmap-grid'); hb.innerHTML = '';
        for(let i=179; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate()-i);
            const ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            const st = getDayStatus(ds);
            let col = '#eaeaea'; if(st===2) col='#B5EAD7'; if(st===1) col='#E0BBE4';
            const cell = document.createElement('div'); cell.className='heat-cell';
            cell.style.background = col; cell.title = ds;
            hb.appendChild(cell);
        }
    }

    // --- ‰øÆÂ§çÁâàÁÆ°ÁêÜÈù¢ÊùøÈÄªËæë ---
    function openManager() { refreshManagerListDOM(); document.getElementById('manager-modal').style.display='flex'; }
    function closeManager() { document.getElementById('manager-modal').style.display='none'; }
    
    // ‰ΩøÁî® document.createElement ÂàõÂª∫ÂàóË°®ÔºåÁ°Æ‰øù‰∫ã‰ª∂ÁªëÂÆöÁªùÂØπÊúâÊïà
    function refreshManagerListDOM() {
        const listContainer = document.getElementById('manager-list');
        listContainer.innerHTML = ''; // Ê∏ÖÁ©∫

        if(appData.habits.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center;color:#999;">List is empty</div>';
            return;
        }

        appData.habits.forEach((habit, i) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'manager-item';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'habit-name-span';
            nameSpan.innerText = habit;

            const delBtn = document.createElement('button');
            delBtn.className = 'btn-delete-item';
            delBtn.innerText = 'Delete';
            
            // ÁÇπÂáªÂà†Èô§ÈÄªËæëÔºöÊó†ÈúÄ confirm ÂºπÁ™óÔºåÈááÁî®ÂèòËâ≤Á°ÆËÆ§
            delBtn.onclick = function(e) {
                e.stopPropagation(); // Èò≤Ê≠¢ÂÜíÊ≥°
                if (this.innerText === 'Sure?') {
                    deleteHabit(i); // Á°ÆËÆ§Âà†Èô§
                } else {
                    // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÔºöÂèòËâ≤ÊèêÁ§∫
                    this.innerText = 'Sure?';
                    this.classList.add('confirm-state');
                    // 3ÁßíÂêéËá™Âä®Â§çÂéü
                    setTimeout(() => {
                        this.innerText = 'Delete';
                        this.classList.remove('confirm-state');
                    }, 3000);
                }
            };

            itemDiv.appendChild(nameSpan);
            itemDiv.appendChild(delBtn);
            listContainer.appendChild(itemDiv);
        });
    }

    document.getElementById('new-habit-input').addEventListener('keypress', (e)=>{
        if(e.key === 'Enter') addNewHabit();
    });

    fetchCloudData();

</script>

</body>
</html>
