<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vintage Diary</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Homemade+Apple&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper-bg: #eaddcf; /* å¤å¤çº¸å¼ è‰² */
            --ink-color: #3e322b;
            --line-color: #bcaaa4;
            --cover-color: #5d4037;
            --accent-red: #8d3e3e;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: #f2f0eb;
            font-family: 'Courier Prime', monospace;
            color: var(--ink-color);
            overflow: hidden;
        }

        /* æ¡Œé¢çº¹ç† */
        body::before {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: radial-gradient(#d7ccc8 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.5; z-index: -1;
        }

        /* --- æ—¥è®°æœ¬ä¸»ä½“ --- */
        .notebook-container {
            position: relative;
            width: 800px; height: 550px;
            perspective: 1500px;
        }

        .notebook {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        /* ä¹¦è„Š */
        .spine-center {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 40px;
            transform: translateX(-50%); background: #3e2723; z-index: 5;
            border-radius: 2px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* é¡µé¢é€šç”¨æ ·å¼ */
        .page {
            position: absolute; top: 0; bottom: 0; width: 50%;
            background-color: var(--paper-bg);
            /* çº¸å¼ çº¹ç†æ»¤é•œ */
            background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.06'/%3E%3C/svg%3E");
            padding: 40px;
            display: flex; flex-direction: column;
            backface-visibility: hidden;
        }

        /* å·¦é¡µ */
        .page-left {
            left: 0; border-radius: 5px 0 0 5px;
            box-shadow: inset -15px 0 30px rgba(0,0,0,0.05);
            border-right: 1px solid #d7ccc8;
            transform-origin: right center;
            z-index: 1;
        }

        /* å³é¡µ */
        .page-right {
            right: 0; border-radius: 0 5px 5px 0;
            box-shadow: inset 15px 0 30px rgba(0,0,0,0.05);
            z-index: 1;
        }

        /* --- ç¿»é¡µåŠ¨ç”»å±‚ --- */
        .flip-page {
            position: absolute; top: 0; bottom: 0; width: 50%;
            background-color: var(--paper-bg);
            z-index: 100;
            backface-visibility: hidden;
            transform-style: preserve-3d;
            transform-origin: left center;
            transition: transform 0.6s cubic-bezier(0.645, 0.045, 0.355, 1);
            pointer-events: none; /* åŠ¨ç”»å±‚ä¸å“åº”ç‚¹å‡» */
            display: none; /* é»˜è®¤éšè— */
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }

        /* --- å·¦é¡µå†…å®¹ (Meta Info) --- */
        .date-header {
            font-family: 'Playfair Display', serif;
            border-bottom: 2px solid var(--ink-color);
            padding-bottom: 15px; margin-bottom: 30px;
            text-align: center;
        }
        .day-num { font-size: 4rem; line-height: 1; font-weight: bold; color: var(--accent-red); display: block; }
        .month-year { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; }
        .weekday { font-family: 'Homemade Apple', cursive; font-size: 1.2rem; color: #666; margin-top: 5px; display: block;}

        .meta-section { margin-bottom: 25px; }
        .section-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: #888; display: block; margin-bottom: 8px; }
        
        .mood-icons { display: flex; gap: 15px; justify-content: center; font-size: 1.5rem; cursor: pointer; }
        .mood-opt { opacity: 0.3; transition: 0.2s; filter: grayscale(1); }
        .mood-opt:hover { opacity: 0.7; }
        .mood-opt.selected { opacity: 1; filter: grayscale(0); transform: scale(1.2); }

        .keyword-input {
            width: 100%; border: none; background: transparent;
            border-bottom: 1px dashed var(--line-color);
            font-family: 'Homemade Apple', cursive; font-size: 1.3rem; color: var(--ink-color);
            text-align: center; padding: 5px;
        }

        /* --- å³é¡µå†…å®¹ (Main Text) --- */
        .paper-lines {
            flex-grow: 1; width: 100%; height: 100%;
            position: relative;
        }
        .diary-input {
            width: 100%; height: 100%;
            border: none; background: transparent; resize: none;
            font-family: 'Homemade Apple', cursive; font-size: 1.2rem; line-height: 30px;
            color: var(--ink-color);
            /* åˆ¶ä½œä¿¡çº¸æ¨ªçº¿ */
            background-image: repeating-linear-gradient(transparent, transparent 29px, var(--line-color) 30px);
            background-attachment: local; /* çº¿æ¡éšæ–‡å­—æ»šåŠ¨ */
            padding-top: 2px;
        }
        .diary-input::placeholder { color: rgba(0,0,0,0.2); }

        /* --- æ§åˆ¶æŒ‰é’® --- */
        .controls-area {
            width: 800px; display: flex; justify-content: space-between; align-items: center;
            margin-top: 20px;
        }
        
        .nav-group { display: flex; gap: 10px; }
        .action-group { display: flex; gap: 10px; }

        .btn {
            background: #fff; border: 1px solid #ccc; padding: 8px 15px; border-radius: 20px;
            font-family: 'Courier Prime', monospace; font-size: 0.85rem; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0); }
        
        .btn-primary { border-color: var(--accent-red); color: var(--accent-red); font-weight: bold; }
        .btn-delete { color: #d32f2f; border-color: transparent; background: transparent; box-shadow: none; }
        .btn-delete:hover { background: #ffebee; }

        .status-text { font-size: 0.8rem; color: #888; margin-left: 10px; font-style: italic; }

        /* é¡µç  */
        .page-num { position: absolute; bottom: 15px; font-size: 0.8rem; color: #999; }
        .page-left .page-num { left: 20px; }
        .page-right .page-num { right: 20px; }

    </style>
</head>
<body>

<!-- æ—¥è®°æœ¬å®¹å™¨ -->
<div class="notebook-container">
    <div class="notebook" id="notebook-el">
        <div class="spine-center"></div>

        <!-- å·¦é¡µï¼šå…ƒæ•°æ® -->
        <div class="page page-left">
            <div class="date-header">
                <span class="day-num" id="display-day">01</span>
                <span class="month-year" id="display-mon-year">JAN 2026</span>
                <span class="weekday" id="display-weekday">Monday</span>
            </div>

            <div class="meta-section">
                <span class="section-label">MOOD</span>
                <div class="mood-icons" id="mood-selector">
                    <span class="mood-opt" data-val="happy">â˜€ï¸</span>
                    <span class="mood-opt" data-val="calm">â˜•</span>
                    <span class="mood-opt" data-val="sad">ğŸŒ§ï¸</span>
                    <span class="mood-opt" data-val="angry">ğŸ”¥</span>
                    <span class="mood-opt" data-val="tired">ğŸ’¤</span>
                </div>
            </div>

            <div class="meta-section">
                <span class="section-label">HIGHLIGHT / TITLE</span>
                <input type="text" class="keyword-input" id="input-title" placeholder="Summary of the day..." oninput="autoSave()">
            </div>

            <span class="page-num" id="page-indicator">Page 1</span>
        </div>

        <!-- å³é¡µï¼šæ­£æ–‡ -->
        <div class="page page-right">
            <div class="paper-lines">
                <textarea class="diary-input" id="input-content" placeholder="Dear Diary..." oninput="autoSave()"></textarea>
            </div>
            <span class="page-num" id="total-count">Total: 1</span>
        </div>
        
        <!-- åŠ¨ç”»è¾…åŠ©å±‚ -->
        <div class="flip-page" id="flip-layer"></div>
    </div>
</div>

<!-- åº•éƒ¨æ§åˆ¶æ  -->
<div class="controls-area">
    <div class="nav-group">
        <button class="btn" onclick="changePage(-1)">â® Prev</button>
        <button class="btn" onclick="changePage(1)">Next â¯</button>
        <button class="btn btn-primary" onclick="createNewEntry()">+ New Entry</button>
    </div>
    
    <div style="display:flex; align-items:center;">
        <span class="status-text" id="status-msg">Loaded from local</span>
        <button class="btn btn-delete" onclick="deleteEntry()">ğŸ—‘ï¸</button>
    </div>

    <div class="action-group">
        <button class="btn" onclick="syncToCloud()">â˜ï¸ Cloud Backup</button>
    </div>
</div>

<script>
    // ============================================
    // â˜ï¸ é…ç½®åŒºåŸŸ (è¯·å¡«å…¥ä½ çš„Key)
    // ============================================
    const CONFIG = {
        // ä¸ºäº†å®‰å…¨å»ºè®®ä½¿ç”¨æ–°çš„ Binï¼Œä½†ç”¨æ—§çš„ä¹Ÿå¯ä»¥
        BIN_ID: "694e065743b1c97be90585f4", 
        API_KEY: "$2a$10$BGU5ci4eEenXveyqNdIs/uNWFKkU6qrov62mlBYBr8kQKh9DCZG0i"
    };
    // ============================================

    // æ•°æ®æ¨¡å‹
    let diaryData = [];
    let currentIndex = 0; // å½“å‰æ˜¾ç¤ºçš„æ—¥è®°ç´¢å¼• (0 = æœ€æ–°ä¸€ç¯‡)

    // åˆ›å»ºæ–°æ—¥è®°å¯¹è±¡
    const createEntry = () => {
        const d = new Date();
        return {
            id: Date.now(),
            date: d.toISOString(), // å­˜å‚¨æ ‡å‡†æ—¶é—´
            mood: "",
            title: "",
            content: ""
        };
    };

    // --- 1. æ ¸å¿ƒé€»è¾‘ ---

    async function init() {
        // ä¼˜å…ˆåŠ è½½æœ¬åœ°
        const local = localStorage.getItem('vintage_diary_v2');
        if (local) {
            diaryData = JSON.parse(local);
            showStatus("Loaded local data");
        } else {
            // æœ¬åœ°æ²¡æœ‰ï¼Œå°è¯•äº‘ç«¯ (é¦–æ¬¡ä½¿ç”¨)
            await fetchFromCloud();
        }

        // å¦‚æœå®Œå…¨ä¸ºç©ºï¼Œåˆ›å»ºä¸€ä¸ª
        if (diaryData.length === 0) {
            diaryData.push(createEntry());
            localStorage.setItem('vintage_diary_v2', JSON.stringify(diaryData));
        }

        // æŒ‰æ—¶é—´å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€å‰)
        sortData();
        renderUI();
    }

    function sortData() {
        diaryData.sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    function autoSave() {
        // ä» UI è·å–æ•°æ®æ›´æ–°åˆ°å½“å‰å¯¹è±¡
        const entry = diaryData[currentIndex];
        entry.title = document.getElementById('input-title').value;
        entry.content = document.getElementById('input-content').value;
        // mood å·²ç»æ˜¯å®æ—¶æ›´æ–°çš„
        
        localStorage.setItem('vintage_diary_v2', JSON.stringify(diaryData));
        showStatus("Saved locally");
    }

    // --- 2. ç•Œé¢æ¸²æŸ“ ---

    function renderUI() {
        if (diaryData.length === 0) return;
        
        // ä¿®æ­£ç´¢å¼•è¶Šç•Œ
        if (currentIndex < 0) currentIndex = 0;
        if (currentIndex >= diaryData.length) currentIndex = diaryData.length - 1;

        const entry = diaryData[currentIndex];
        const dateObj = new Date(entry.date);

        // æ¸²æŸ“æ—¥æœŸ
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        
        document.getElementById('display-day').innerText = String(dateObj.getDate()).padStart(2, '0');
        document.getElementById('display-mon-year').innerText = `${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
        document.getElementById('display-weekday').innerText = days[dateObj.getDay()];

        // æ¸²æŸ“å†…å®¹
        document.getElementById('input-title').value = entry.title || "";
        document.getElementById('input-content').value = entry.content || "";

        // æ¸²æŸ“å¿ƒæƒ…
        document.querySelectorAll('.mood-opt').forEach(el => {
            el.classList.remove('selected');
            if (el.dataset.val === entry.mood) el.classList.add('selected');
        });

        // æ¸²æŸ“é¡µç 
        document.getElementById('page-indicator').innerText = `Entry ${diaryData.length - currentIndex}`;
        document.getElementById('total-count').innerText = `Total: ${diaryData.length}`;
    }

    // å¿ƒæƒ…é€‰æ‹©ç»‘å®š
    document.querySelectorAll('.mood-opt').forEach(el => {
        el.onclick = function() {
            diaryData[currentIndex].mood = this.dataset.val;
            renderUI(); // åˆ·æ–°é«˜äº®
            autoSave();
        };
    });

    // --- 3. ç¿»é¡µä¸æ“ä½œ ---

    function changePage(dir) {
        // dir: 1 (Next/Older), -1 (Prev/Newer)
        const nextIdx = currentIndex + dir;
        
        if (nextIdx < 0 || nextIdx >= diaryData.length) {
            // ç¿»ä¸åŠ¨äº†
            return; 
        }

        // è§†è§‰åŠ¨ç”»æ¨¡æ‹Ÿ
        const notebook = document.getElementById('notebook-el');
        // ç®€å•çš„å€¾æ–œåŠ¨ç”»è¡¨ç¤ºç¿»é¡µ
        notebook.style.transform = dir > 0 ? "rotateY(-5deg) translateX(-10px)" : "rotateY(5deg) translateX(10px)";
        
        setTimeout(() => {
            currentIndex = nextIdx;
            renderUI();
            notebook.style.transform = "rotateY(0) translateX(0)";
        }, 200);
    }

    function createNewEntry() {
        // å¦‚æœæœ€æ–°çš„ä¸€ç¯‡æ˜¯ä»Šå¤©å†™çš„ï¼Œä¸”æ˜¯ç©ºçš„ï¼Œåˆ™ä¸åˆ›å»º
        const today = new Date().toDateString();
        const latestDate = new Date(diaryData[0].date).toDateString();
        
        if (diaryData.length > 0 && today === latestDate && diaryData[0].content === "") {
            showStatus("Today's page already exists!");
            currentIndex = 0;
            renderUI();
            return;
        }

        diaryData.unshift(createEntry()); // åŠ åˆ°æœ€å‰é¢
        sortData();
        currentIndex = 0;
        localStorage.setItem('vintage_diary_v2', JSON.stringify(diaryData));
        
        // åŠ¨ç”»
        const notebook = document.getElementById('notebook-el');
        notebook.style.transition = "none";
        notebook.style.transform = "scale(0.98)";
        setTimeout(() => {
            notebook.style.transition = "transform 0.5s ease";
            notebook.style.transform = "scale(1)";
            renderUI();
            showStatus("New page created");
        }, 100);
    }

    function deleteEntry() {
        if (confirm("Tear out this page permanently?")) {
            diaryData.splice(currentIndex, 1);
            if (diaryData.length === 0) diaryData.push(createEntry()); // è‡³å°‘ç•™ä¸€é¡µ
            
            localStorage.setItem('vintage_diary_v2', JSON.stringify(diaryData));
            currentIndex = Math.min(currentIndex, diaryData.length - 1);
            renderUI();
            showStatus("Page deleted");
        }
    }

    // --- 4. äº‘ç«¯åŒæ­¥ ---

    async function syncToCloud() {
        showStatus("Syncing to cloud...");
        try {
            await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Master-Key': CONFIG.API_KEY
                },
                body: JSON.stringify({ diary: diaryData })
            });
            showStatus("Synced successfully âœ“");
        } catch (e) {
            console.error(e);
            showStatus("Cloud Error (Check Key/Net)");
        }
    }

    async function fetchFromCloud() {
        showStatus("Fetching cloud data...");
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                headers: { 'X-Master-Key': CONFIG.API_KEY }
            });
            if(res.ok) {
                const json = await res.json();
                if (json.record && json.record.diary) {
                    diaryData = json.record.diary;
                    localStorage.setItem('vintage_diary_v2', JSON.stringify(diaryData));
                    renderUI();
                    showStatus("Cloud data loaded");
                }
            }
        } catch (e) {
            showStatus("Offline mode");
        }
    }

    function showStatus(msg) {
        const el = document.getElementById('status-msg');
        el.innerText = msg;
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0.5, 3000);
    }

    // å¯åŠ¨
    init();

</script>

</body>
</html>
