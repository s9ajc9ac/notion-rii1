<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Memo</title>
    <!-- ÂºïÂÖ•ÊâãÂÜôÈ£éÊ†ºÂ≠ó‰Ωì -->
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Indie+Flower&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-green: #DCE7E0;     /* ËÉåÊôØÁÅ∞Áªø */
            --paper-cream: #FDFBF7;  /* Âç°ÁâáÁ±≥ÁôΩ */
            --ink-teal: #1A4D45;     /* Â¢®ÁªøÊñáÂ≠ó */
            --accent-pink: #F29C9F;  /* ‰∏ùÂ∏¶/‰ø°Â∞ÅÁ≤â */
            --shadow-soft: rgba(26, 77, 69, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 20px;
            background-color: var(--bg-green);
            /* Ê®°ÊãüÁ∫∏Âº†Á∫πÁêÜ */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            font-family: 'Indie Flower', cursive;
            color: var(--ink-teal);
            height: 100vh;
            display: flex; justify-content: center;
            overflow: hidden;
        }

        /* ‰∏ªÂç°ÁâáÂÆπÂô® */
        .card-container {
            width: 100%; max-width: 900px;
            background-color: var(--paper-cream);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            display: flex; flex-direction: column;
            position: relative; height: 95vh;
            border: 1px solid rgba(255,255,255,0.6);
        }

        /* È°∂ÈÉ®Ë£ÖÈ•∞ */
        .header-decoration {
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='12' viewBox='0 0 40 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 6 Q 10 0 20 6 T 40 6' stroke='%23F29C9F' fill='none' stroke-width='2'/%3E%3C/svg%3E");
            background-repeat: repeat-x; background-size: 40px 12px;
            margin: 20px 20px 0 20px; opacity: 0.8;
        }

        /* ËæìÂÖ•Âå∫ */
        .input-area { padding: 10px 30px 20px 30px; text-align: center; flex-shrink: 0; }
        h1 { font-family: 'Caveat', cursive; font-size: 2.5rem; margin: 0 0 15px 0; color: var(--ink-teal); font-weight: 700; }
        
        .input-wrapper { position: relative; max-width: 600px; margin: 0 auto; }
        #note-input {
            width: 100%; border: none; background: transparent;
            border-bottom: 2px dashed var(--bg-green);
            font-family: 'Indie Flower', cursive; font-size: 1.2rem;
            padding: 10px 40px 10px 10px; color: var(--ink-teal);
            resize: none; height: 50px; transition: all 0.3s;
        }
        #note-input:focus { border-bottom-color: var(--accent-pink); }
        
        .add-btn {
            position: absolute; right: 5px; bottom: 10px;
            background: none; border: none; color: var(--accent-pink);
            font-size: 1.5rem; cursor: pointer; transition: transform 0.2s;
        }
        .add-btn:hover { transform: scale(1.2) rotate(10deg); }

        /* ‰æøÁ≠æÂ±ïÁ§∫Âå∫ */
        .notes-grid {
            flex-grow: 1; overflow-y: auto;
            padding: 20px 30px 80px 30px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px; align-content: start;
        }
        .notes-grid::-webkit-scrollbar { width: 6px; }
        .notes-grid::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 3px; }

        .note-card {
            background: #fff; border: 1px solid #f0f0f0; border-radius: 8px;
            padding: 15px; cursor: pointer; transition: all 0.2s;
            box-shadow: 2px 2px 0px var(--bg-green);
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 120px; max-height: 200px;
        }
        .note-card:hover { transform: translateY(-3px); box-shadow: 4px 4px 0px var(--accent-pink); border-color: var(--accent-pink); }
        
        .note-content {
            font-size: 1.1rem; line-height: 1.4;
            overflow: hidden; display: -webkit-box;
            -webkit-line-clamp: 5; -webkit-box-orient: vertical;
            margin-bottom: 10px; white-space: pre-wrap;
        }
        .note-meta { font-size: 0.8rem; color: #8fa39f; font-family: sans-serif; text-align: right; margin-top: auto; }

        /* ÂΩíÊ°£Êù° */
        .archive-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50px;
            background-color: var(--accent-pink); border-radius: 0 0 15px 15px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; color: white;
            font-family: 'Caveat', cursive; font-size: 1.4rem; font-weight: bold;
            transition: height 0.3s; z-index: 10;
        }
        .archive-bar:hover { height: 60px; }

        /* Loading ÈÅÆÁΩ© */
        .loading-mask {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(253, 251, 247, 0.9); z-index: 500;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; color: var(--accent-pink); flex-direction: column; gap: 10px;
        }
        .loading-spinner {
            width: 30px; height: 30px; border: 3px solid #eee;
            border-top: 3px solid var(--accent-pink); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ê®°ÊÄÅÊ°Ü */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(253, 251, 247, 0.95); backdrop-filter: blur(2px);
            z-index: 20; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .detail-card {
            background: white; width: 80%; max-width: 500px;
            padding: 30px; border-radius: 10px;
            box-shadow: 10px 10px 0px var(--bg-green); border: 2px solid var(--ink-teal);
            position: relative;
        }
        .detail-text { font-size: 1.4rem; line-height: 1.6; margin-bottom: 30px; max-height: 60vh; overflow-y: auto; white-space: pre-wrap; }
        .detail-actions { display: flex; justify-content: flex-end; gap: 15px; }

        .btn { border: none; padding: 8px 16px; border-radius: 20px; font-family: 'Indie Flower', cursive; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: all 0.2s; }
        .btn-archive { background: var(--ink-teal); color: white; }
        .btn-delete { background: transparent; color: #ff6b6b; border: 1px solid #ff6b6b; }
        .btn-close { position: absolute; top: 10px; right: 15px; background: none; font-size: 1.5rem; color: #999; cursor: pointer; border: none; }

        /* ÂΩíÊ°£ÂàóË°® */
        .archive-content { width: 80%; height: 80%; display: flex; flex-direction: column; }
        .archive-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed var(--accent-pink); padding-bottom: 10px; margin-bottom: 20px; }
        .archive-list { overflow-y: auto; flex-grow: 1; }
        .archive-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .archive-item:hover { background: rgba(242, 156, 159, 0.1); }
    </style>
</head>
<body>

<div class="card-container">
    <div class="header-decoration"></div>
    
    <!-- Ê†áÈ¢ò‰∏éËæìÂÖ• -->
    <div class="input-area">
        <h1 id="status-title">Cloud Memo</h1>
        <div class="input-wrapper">
            <input type="text" id="note-input" placeholder="Jot down something lovely..." autocomplete="off">
            <button class="add-btn" onclick="addNote()">‚ú¶</button>
        </div>
    </div>

    <!-- ‰æøÁ≠æÁΩëÊ†º -->
    <div class="notes-grid" id="notes-grid"></div>

    <!-- ÂΩíÊ°£Êù° -->
    <div class="archive-bar" onclick="openArchiveModal()">
        <span class="archive-icon">üíå</span> Archive Box
    </div>

    <!-- Loading ÈÅÆÁΩ© -->
    <div class="loading-mask" id="loading-mask">
        <div class="loading-spinner"></div>
        <div id="loading-text">Connecting...</div>
    </div>
</div>

<!-- ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
<div class="modal-overlay" id="detail-modal">
    <div class="detail-card">
        <button class="btn-close" onclick="closeModal('detail-modal')">√ó</button>
        <div class="detail-text" id="detail-content"></div>
        <div class="detail-actions" id="detail-actions">
            <!-- JS Â°´ÂÖÖÊåâÈíÆ -->
        </div>
    </div>
</div>

<!-- ÂΩíÊ°£ÂàóË°®Ê®°ÊÄÅÊ°Ü -->
<div class="modal-overlay" id="archive-modal">
    <div class="archive-content">
        <div class="archive-header">
            <h2 style="margin:0; font-family:'Caveat'; color:var(--accent-pink);">Archived Notes</h2>
            <button class="btn-close" style="position:static;" onclick="closeModal('archive-modal')">√ó</button>
        </div>
        <div class="archive-list" id="archive-list">
            <!-- JS ÁîüÊàêÂàóË°® -->
        </div>
    </div>
</div>

<script>
    // ============================================
    // ‚òÅÔ∏è ÊÇ®ÁöÑ‰∏ìÂ±û‰∫ëÁ´ØÈÖçÁΩÆ
    // ============================================
    const CONFIG = {
        BIN_ID: "694df90bd0ea881f404093e4",
        API_KEY: "$2a$10$ZCtav3eUvsq6lxm97e.e8.9JHlS0p/6Qh4ELXFdlECtgFY/1L1mz6"
    };
    // ============================================

    let notes = [];

    // --- 1. ‰∫ëÁ´ØÂêåÊ≠•Ê†∏ÂøÉ ---

    const showLoading = (show, text) => {
        const mask = document.getElementById('loading-mask');
        if (show) {
            mask.style.display = 'flex';
            if(text) document.getElementById('loading-text').innerText = text;
        } else {
            mask.style.display = 'none';
        }
    };

    // ËØªÂèñ‰∫ëÁ´ØÊï∞ÊçÆ
    async function fetchCloudData() {
        showLoading(true, "Syncing... ‚òÅÔ∏è");
        try {
            // Ê≥®ÊÑèÔºöAPI ÈúÄÂä† /latest ËØªÂèñÊúÄÊñ∞Áâà
            const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                headers: { 'X-Master-Key': CONFIG.API_KEY }
            });
            
            if (!response.ok) throw new Error('Network error');
            const data = await response.json();
            
            // JSONBin ÁöÑÊï∞ÊçÆÁªìÊûÑÈÄöÂ∏∏ÊòØ { record: { notes: [...] }, metadata: ... }
            // Êàë‰ª¨ÈúÄË¶Å record ÈáåÈù¢ÁöÑÂÜÖÂÆπ
            notes = data.record.notes || []; 
            renderNotes();
        } catch (error) {
            console.error("Fetch Error:", error);
            // Â¶ÇÊûúÁ¨¨‰∏ÄÊ¨°ËØªÂèñÂ§±Ë¥•ÔºàÊØîÂ¶Ç Bin Ê†ºÂºè‰∏çÂØπÔºâÔºåÂàùÂßãÂåñ‰∏∫Á©∫Êï∞ÁªÑ
            notes = [];
            renderNotes();
        } finally {
            showLoading(false);
        }
    }

    // ‰øùÂ≠òÂà∞‰∫ëÁ´Ø
    async function saveToCloud() {
        const title = document.getElementById('status-title');
        const originalText = "Cloud Memo";
        title.innerText = "Saving... üíæ";
        
        try {
            await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': CONFIG.API_KEY
                },
                body: JSON.stringify({ notes: notes })
            });
            title.innerText = "Saved! ‚ú®";
            setTimeout(() => title.innerText = originalText, 2000);
        } catch (error) {
            console.error("Save Error:", error);
            alert("Save failed! Please check internet.");
            title.innerText = "Error ‚ùå";
        }
    }

    // --- 2. ‰∏öÂä°ÈÄªËæë ---

    function addNote() {
        const input = document.getElementById('note-input');
        const content = input.value.trim();
        if (!content) return;

        const newNote = {
            id: Date.now(),
            content: content,
            timestamp: Date.now(),
            archived: false
        };

        notes.unshift(newNote); // Âä†Âà∞ÊúÄÂâçÈù¢
        input.value = '';
        renderNotes();
        saveToCloud(); // Ëá™Âä®‰øùÂ≠ò
    }

    function toggleArchive(id) {
        const note = notes.find(n => n.id === id);
        if (note) {
            note.archived = !note.archived;
            renderNotes();
            closeModal('detail-modal');
            
            // Â¶ÇÊûúÊòØÂú®ÂΩíÊ°£ÂàóË°®ÈáåÊìç‰ΩúÁöÑÔºåÂà∑Êñ∞ÂΩíÊ°£ÂàóË°®
            if (document.getElementById('archive-modal').style.display === 'flex') {
                openArchiveModal(); 
            }
            saveToCloud(); // Ëá™Âä®‰øùÂ≠ò
        }
    }

    function deleteNote(id) {
        if(confirm('Truly discard this thought?')) {
            notes = notes.filter(n => n.id !== id);
            renderNotes();
            closeModal('detail-modal');
            
            if (document.getElementById('archive-modal').style.display === 'flex') {
                openArchiveModal();
            }
            saveToCloud(); // Ëá™Âä®‰øùÂ≠ò
        }
    }

    // --- 3. Ê∏≤ÊüìÈÄªËæë ---

    const formatTime = (ts) => {
        const date = new Date(ts);
        const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleDateString('en-US', options);
    };

    function renderNotes() {
        const grid = document.getElementById('notes-grid');
        grid.innerHTML = '';

        const activeNotes = notes.filter(n => !n.archived);

        if (activeNotes.length === 0) {
            grid.innerHTML = `<div style="width:100%; text-align:center; opacity:0.5; margin-top:50px;">
                Cloud is quiet... üçÉ
            </div>`;
            return;
        }

        activeNotes.forEach(note => {
            const card = document.createElement('div');
            card.className = 'note-card';
            card.onclick = () => openDetailModal(note.id);
            // Â§ÑÁêÜÊç¢Ë°åÊòæÁ§∫
            const displayContent = note.content.replace(/\n/g, '<br>');
            card.innerHTML = `
                <div class="note-content">${displayContent}</div>
                <div class="note-meta">${formatTime(note.timestamp)}</div>
            `;
            grid.appendChild(card);
        });
    }

    // --- 4. Ê®°ÊÄÅÊ°Ü‰∫§‰∫í ---

    function openDetailModal(id) {
        const note = notes.find(n => n.id === id);
        if (!note) return;

        document.getElementById('detail-content').innerText = note.content;
        
        const actionsDiv = document.getElementById('detail-actions');
        const archiveBtnText = note.archived ? 'Unarchive' : 'Archive ‚ú®';
        
        actionsDiv.innerHTML = `
            <button class="btn btn-delete" onclick="deleteNote(${note.id})">Discard</button>
            <button class="btn btn-archive" onclick="toggleArchive(${note.id})">${archiveBtnText}</button>
        `;

        document.getElementById('detail-modal').classList.add('active');
    }

    function openArchiveModal() {
        const listContainer = document.getElementById('archive-list');
        listContainer.innerHTML = '';
        const archivedNotes = notes.filter(n => n.archived);

        if (archivedNotes.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">The envelope is empty.</div>';
        } else {
            archivedNotes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'archive-item';
                div.onclick = () => openDetailModal(note.id);
                div.innerHTML = `
                    <span class="archive-item-text" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70%;">${note.content}</span>
                    <span class="note-meta" style="margin:0;">${format
